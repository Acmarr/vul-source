import json
import pytest
import os
from test_utils import TestUtilities as util

from datalib import (
    ReleaseStorage,
    UCTCVEStorage,
    UCTPackageStorage,
    USNStorage,
)

from data_generation.osv_lib import cve2osv, usn2osv

if 'UCT' not in os.environ:
    raise Exception("missing UCT in environment")

release_storage = ReleaseStorage()
active_releases = release_storage.get_product_releases("ubuntu", True)
active_releases += release_storage.esm_apps_releases
active_releases += release_storage.esm_infra_releases

cve_storage = UCTCVEStorage()
cve_storage.link_release_storage(release_storage)
cve_storage.load()

package_storage = UCTPackageStorage()
package_storage.link_release_storage(release_storage)
package_storage.load(filter_releases=active_releases)
cve_storage.link_pkg_storage(package_storage)

usn_storage = USNStorage()
usn_storage.link_release_storage(release_storage)
usn_storage.load()
usn_storage.link_pkg_storage(package_storage)
usn_storage.link_cve_storage(cve_storage)


class TestMockData:
    @pytest.mark.parametrize(
        "cve_id", [("CVE-0000-0001"), ("CVE-0000-0002"), ("CVE-0000-0003")]
    )
    def test_gold_cves(self, cve_id):
        output_file = "./" + cve_id + ".json"
        util.files_to_del.add(output_file)
        cve_storage.load_cve(os.environ['UCT'] + "/test/osv/gold_cve_files/" + cve_id)
        cve2osv("./", cve_storage.get_cve(cve_id), "dummylog")
        gold_json = json.load(open(os.environ['UCT'] + "/test/osv/gold_osv_files/" + cve_id + ".json"))
        assert json.load(open(output_file)) == gold_json

    @pytest.mark.parametrize(
        "usn_id", [("2169-1"), ("6850-1"), ("6246-1")]
    )
    def test_gold_usns(self, usn_id):
        output_file = "./USN-" + usn_id + ".json"
        util.files_to_del.add(output_file)
        usn = usn_storage.get_usn(usn_id)
        usn2osv("./", usn, "dummylog")
        gold_json = json.load(open(os.environ["UCT"] + "/test/osv/gold_osv_files/USN-" + usn_id + ".json"))
        assert json.load(open(output_file)) == gold_json
