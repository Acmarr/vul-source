#!/usr/bin/env python3
# Main script to trigger data generation
#
# Author: Eduardo Barretto <eduardo.barretto@canonical.com>
# Copyright (C) 2024 Canonical, Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 3 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.
#
# TODO: improve arguments, perhaps nest arguments (e.g. osv cve)

from argparse import ArgumentParser, ArgumentDefaultsHelpFormatter
from datalib import ReleaseStorage, UCTCVEStorage, UCTPackageStorage, USNStorage
from data_generation.osv_lib import cve2osv, usn2osv
from data_generation.vex_lib import CVE_VEXDocument, USN_VEXDocument
from data_generation.utils import get_changed_cves, get_changed_usns, get_vex_doc_version, read_last_commit_hash, write_current_commit_hash
from datetime import datetime

import logging
import os

logger = logging.getLogger(__name__)

def set_logger(level):
    now = datetime.now()
    timenow = now.strftime("%Y-%m-%d-%H:%M:%S")

    if level == "DEBUG":
        lvl = logging.DEBUG
    elif level == "INFO":
        lvl = logging.INFO
    elif level == "WARNING":
        lvl = logging.WARNING
    elif level == "ERROR":
        lvl = logging.ERROR
    elif level == "CRITICAL":
        lvl = logging.CRITICAL

    logging.basicConfig(filename=f"/tmp/data-generation-{timenow}.log", level=lvl)
    logger.warning(f"Setting debug level to {level}")


def load_input_data():
    # release_storage = ReleaseStorage()
    release_storage = ReleaseStorage()
    active_releases = release_storage.get_product_releases("ubuntu", True)
    active_releases += release_storage.esm_apps_releases
    active_releases += release_storage.esm_infra_releases

    cve_storage = UCTCVEStorage()
    cve_storage.link_release_storage(release_storage)
    cve_storage.load()

    package_storage = UCTPackageStorage()
    package_storage.link_release_storage(release_storage)
    # package_storage.load()
    package_storage.load(filter_releases=active_releases)

    usn_storage = USNStorage()
    usn_storage.link_release_storage(release_storage)
    usn_storage.load()

    cve_storage.link_pkg_storage(package_storage)
    usn_storage.link_pkg_storage(package_storage)
    usn_storage.link_cve_storage(cve_storage)

    return cve_storage, package_storage, usn_storage, release_storage


def prepare_output_dir(output_dir, type, data_source, year=""):
    outdir = os.path.join(os.path.expanduser(output_dir), type, data_source, year)

    if not os.path.exists(outdir):
        logger.warning(f"Creating output dir {outdir}")
        os.makedirs(outdir, 0o775)
    elif not os.path.isdir(outdir):
        logger.error(f"{outdir} is not a directory, exiting!")
        exit(1)

    return outdir


def parse_options():
    parser = ArgumentParser(formatter_class=ArgumentDefaultsHelpFormatter)

    parser.add_argument(
        "-d",
        "--debug-level",
        default="error",
        choices=["debug", "info", "warning", "error", "critical"],
        help="Define debug level",
    )
    parser.add_argument(
        "--type",
        required=True,
        default="all",
        choices=["json-pkg", "osv", "vex", "oval", "all"],
        help="Define what type of data to generate",
    )
    parser.add_argument(
        "--range",
        default="all",
        choices=["latest", "all"],
        help="Define what range of data should be generated, for the supported types (VEX and OSV)",
    )
    parser.add_argument(
        "-o",
        "--output-dir",
        action="store",
        default=None,
        required=True,
        help="Directory to store generated files",
    )
    parser.add_argument(
        "-p",
        "--previous-dir",
        action="store",
        default=None,
        required=False,
        help="Directory where previous files are stored",
    )
    parser.add_argument(
        "--cves",
        nargs="+",
        default=None,
        help="Space separated list of CVE ids"
    )
    parser.add_argument(
        "--usns",
        nargs="+",
        default=None,
        help="Space separated list of USN ids"
    )
    parser.add_argument(
        "--releases",
        nargs="+",
        default=None,
        help="Space separated list of Ubuntu releases",
    )
    parser.add_argument(
        "--packages",
        nargs="+",
        default=None,
        help="Space separated list of source packages",
    )
    options = parser.parse_args()

    return options


def main():
    options = parse_options()

    set_logger(options.debug_level.upper())

    cve_info, pkg_info, usn_info, release_info = load_input_data()

    if options.range == 'all':
        # OSV generation
        if options.type == 'osv' or options.type == 'all':
            for usn in usn_info.sns:
                logger.debug(f"Generating OSV data for USN-{usn}")
                output_dir = prepare_output_dir(options.output_dir, "osv", "usn")
                usn2osv(output_dir, usn_info.get_usn(usn))

            for cve in cve_info.cves:
                logger.debug(f"Generating OSV data for {cve}")
                output_dir = prepare_output_dir(options.output_dir, "osv", "cve", cve.split('-')[1])
                cve2osv(output_dir, cve_info.get_cve(cve))

        # VEX generation
        if options.type == 'vex' or options.type == 'all':
            if options.previous_dir is not None:
                previous_dir_cves = os.path.join(options.previous_dir, "vex", "cve")
                previous_dir_usns = os.path.join(options.previous_dir, "vex", "usn")

            for cve_id in reversed(cve_info.cves):
                output_dir = prepare_output_dir(options.output_dir, "vex", "cve", cve_id.split('-')[1])
                # determine the current version of the document
                if options.previous_dir is None:
                    version = 1
                else:
                    version = get_vex_doc_version(os.path.join(previous_dir_cves, cve_id + ".json")) + 1
                # get the CVE and generate the relevant VEX data
                cve = cve_info.get_cve(cve_id)
                logger.debug(f"Generating VEX data for {cve}")
                vex = CVE_VEXDocument(cve, output_dir, version)
                output_file = cve.id + ".json"
                vex.generate_document(output_file)

            for usn_id in reversed(usn_info.sns):
                output_dir = prepare_output_dir(options.output_dir, "vex", "usn")
                # determine the current version of the document
                if options.previous_dir is None:
                    version = 1
                else:
                    version = get_vex_doc_version(os.path.join(previous_dir_usns, "USN-" + usn_id + ".json")) + 1
                # get the USN and generate the relevant VEX data
                usn = usn_info.get_usn(usn_id)
                logger.debug(f"Generating VEX data for USN-{usn_id}")
                vex = USN_VEXDocument(usn, output_dir, version)
                output_file = "USN-" + usn.id + ".json"
                vex.generate_document(output_file)

    elif options.range == 'latest':
        # OSV generation
        if options.type == 'osv' or options.type == 'all':
            # generate OSV data for the changed USN files
            # get the commit for the commit cache and
            # find out the changed cves since that commit
            commit_hash = read_last_commit_hash("USN")
            usns_changed = get_changed_usns(commit_hash)
            for usn in usns_changed:
                logger.debug(f"Generating OSV data for USN-{usn}")
                output_dir = prepare_output_dir(options.output_dir, "osv", "usn")
                usn2osv(output_dir, usn_info.get_usn(usn))

            # generate OSV data for the changed CVE files
            # get the commit for the commit cache and
            # find out the changed cves since that commit
            commit_hash = read_last_commit_hash("CVE")
            cves_changed = get_changed_cves(commit_hash)

            for cve in cves_changed:
                output_dir = prepare_output_dir(options.output_dir, "osv", "cve", cve.split('-')[1])
                if cve not in cve_info.cves:
                    continue
                cve_info.load_cve(cve)
                logger.debug(f"Generating OSV data for {cve}")
                cve2osv(output_dir, cve_info.get_cve(cve))

        # VEX generation
        if options.type == 'vex' or options.type == 'all':
            if options.previous_dir is not None:
                previous_dir_cves = os.path.join(options.previous_dir, "vex", "cve")
                previous_dir_usns = os.path.join(options.previous_dir, "vex", "usn")

            # generate VEX data for the changed CVE files
            # get the commit for the commit cache and
            # find out the changed cves since that commit
            commit_hash = read_last_commit_hash("CVE")
            cves_changed = get_changed_cves(commit_hash)

            # generate the vex documents
            for cve_id in cves_changed:
                output_dir = prepare_output_dir(options.output_dir, "vex", "cve", cve_id.split('-')[1])
                # get the current version of the document and increase it by 1
                if options.previous_dir is None:
                    version = 1
                else:
                    version = get_vex_doc_version(os.path.join(previous_dir_cves, cve_id + ".json")) + 1

                if cve_id not in cve_info.cves:
                    continue
                cve_info.load_cve(cve_id)
                cve_object = cve_info.get_cve(cve_id)
                logger.debug(f"Generating VEX data for {cve_id}")
                vex = CVE_VEXDocument(cve_object, output_dir, version)
                output_file = cve_id + ".json"
                vex.generate_document(output_file)


            # generate VEX data for the changed USN files

            # get the commit for the commit cache and
            # find out the changed cves since that commit
            commit_hash = read_last_commit_hash("USN")
            usns_changed = get_changed_usns(commit_hash)

            for usn_id in usns_changed:
                output_dir = prepare_output_dir(options.output_dir, "vex", "usn")

                # get the current version of the document and increase it by 1
                logger.debug(f"Generating VEX data for USN-{usn_id}")
                if options.previous_dir is None:
                    version = 1
                else:
                    version = get_vex_doc_version(os.path.join(previous_dir_usns, "USN-" + usn_id + ".json")) + 1

                usn = usn_info.get_usn(usn_id)
                vex = USN_VEXDocument(usn, output_dir, version)
                output_file = "USN-" + usn.id + ".json"
                vex.generate_document(output_file)

    # update the commit cache with the current one, as data
    # was just generated
    write_current_commit_hash("CVE")
    write_current_commit_hash("USN")

    return 0


if __name__ == "__main__":
    exit(main())
