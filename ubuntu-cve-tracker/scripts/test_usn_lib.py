#!/usr/bin/env pytest-3
# -*- coding: utf-8 -*-
#
# Author: Steve Beattie <sbeattie@ubuntu.com>
# Copyright (C) 2020 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 3 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.
#
# Simple tests for usn_lib

from usn_lib import (
    parse_archive_url,
    USNdb, USNdbOpt
)

class TestParseArchiveUrl:
    def test_basic_url(self):
        url = "http://security.ubuntu.com/ubuntu/pool/main/l/linux-hwe/block-modules-4.18.0-14-generic-di_4.18.0-14.15~18.04.1_amd64.udeb"
        assert parse_archive_url(url) == ("main", "linux-hwe", "block-modules-4.18.0-14-generic-di", "4.18.0-14.15~18.04.1", 'amd64')

    def test_ports_url(self):
        url = "Ã¾tp://ports.ubuntu.com/pool/main/l/linux-hwe/linux-image-4.18.0-14-generic_4.18.0-14.15~18.04.1_armhf.deb"
        assert parse_archive_url(url) == ("main", "linux-hwe", "linux-image-4.18.0-14-generic", "4.18.0-14.15~18.04.1", 'armhf')

    def test_bad_security_url(self):
        assert parse_archive_url("http://security.ubuntu.com/ubuntu/pool/") is None

    def test_bad_ports_url(self):
        assert parse_archive_url("http://ports.ubuntu.com/pool/") is None

class UctlpMock(object):
    def __init__(self, answer):
        self.answer = answer

    def get_earliest_version(self, release, package):
        return self.answer

class TestGetLatestUsnVersion:
    def test_existing_usn_no_glitches(self):
        usndb = USNdb([], "scripts/testfiles/usn_lib/test-database.pickle", opt=USNdbOpt(debug=False, use_glitches=False))
        expected = "6.8.0-40.40"
        got = usndb.get_latest_usn_version("linux", "noble")
        assert expected == got

    def test_existing_usn_glitches(self):
        usndb = USNdb([], "scripts/testfiles/usn_lib/test-database.pickle", opt=USNdbOpt(debug=False, use_glitches=True))
        expected = "6.8.0-40.40"
        got = usndb.get_latest_usn_version("linux", "noble")
        assert expected == got

    def test_existing_usn_glitches_override(self):
        usndb = USNdb([], "scripts/testfiles/usn_lib/test-database.pickle", opt=USNdbOpt(debug=False, use_glitches=True))
        expected = "4.18.0-1024.25"
        got = usndb.get_latest_usn_version("linux-azure", "cosmic")
        assert expected == got

    def test_non_existing_usn_glitches(self):
        usndb = USNdb([], "scripts/testfiles/usn_lib/test-database.pickle", opt=USNdbOpt(debug=False, use_glitches=True))
        expected = "5.4.0-1022.26"
        got = usndb.get_latest_usn_version("linux-xilinx-zynqmp", "focal")
        assert expected == got

    def test_non_existing_usn_glitches_none(self):
        usndb = USNdb([], "scripts/testfiles/usn_lib/test-database.pickle", opt=USNdbOpt(debug=False, use_glitches=True))
        expected = None
        got = usndb.get_latest_usn_version("linux-xilinx-zynqmp", "xenial")
        assert expected == got

    def test_non_existing_usn_no_glitches(self):
        usndb = USNdb([], "scripts/testfiles/usn_lib/test-database.pickle", opt=USNdbOpt(debug=True, use_glitches=False))
        expected = None
        got = usndb.get_latest_usn_version("linux-xilinx-zynqmp", "focal")
        assert expected == got
