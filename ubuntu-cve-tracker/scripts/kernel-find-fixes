#!/bin/bash
#
# Find possible `Fixes:` tagged commits for an upstream commit hash
#
# Authors:
# 	Thadeu Lima de Souza Cascardo <thadeu.cascardo@canonical.com>
# 	Cengiz Can <cengiz.can@canonical.com>
#

# USER CONFIGURATION STARTS
#
# Should be updated accordingly:

[ -f "$HOME"/.ubuntu-cve-tracker.conf ] && . "$HOME"/.ubuntu-cve-tracker.conf

UPSTREAM_KERNEL_DIR="${linux_kernel_path:-~/kernel/upstream}"
KERNEL_VERSIONS='6.5 6.2 6.1 5.19 5.15 5.14 5.10 5.4 4.19 4.15 4.14 4.9 4.4'
IFS=" " read -r -a kernel_versions <<< "$KERNEL_VERSIONS"
#
# USER CONFIGURATION ENDS

SHA1=$1

# For Short SHA1
SHORT=$(echo "$1" | cut -b1-6)

cd "$UPSTREAM_KERNEL_DIR" || exit

echo "Title for $SHA1"
git --no-pager show --no-patch --format='Fixes: %h ("%s")' "$SHA1"

echo "$SHA1 was at:"
TAG=$(git --no-pager describe --contains --match 'v*' "$SHA1")
echo "Tag: $TAG"

if [ -n "$TAG" ]; then
	RC=$(echo "$TAG" | grep -oE '^[^~]*')
	echo "Tag prefix: $RC"

	TAG_DATE=$(TZ=UTC git --no-pager for-each-ref \
			      --format="%(refname:short) | %(creatordate:iso-local)" \
			      "refs/tags/$RC")
	echo "Tag date: $TAG_DATE"
fi

echo "Looking for references to $SHORT in origin/master"
git --no-pager log --grep="$SHORT" "$SHA1"..origin/master

echo "Looking for references to $SHORT in next/master"
git --no-pager log --grep="$SHORT" origin/master..next/master

echo "Looking for references to $SHORT in stable releases"

for i in "${kernel_versions[@]}"; do
	echo "Looking for references to $SHORT in $i"
	git --no-pager log --oneline --grep="$SHORT" "v$i".."stable/linux-$i.y"
done
